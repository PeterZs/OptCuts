% !TeX root = OptCuts.tex

\section{Problem Statement}
%\minchen{As Vova suggested, describe Self-Weighting as our main formulation before Joint Discrete-Continuous Search, so does Abstract, Introduction, and Section 4 and 5.}
% \danny{Also took a pretty heavy pass at re-organizing this section and the next.}

Given an input triangle mesh $M=(V,F)$ of a three-dimensional surface with vertices $V$, and faces $F$, we seek a UV map with topology $T^*=(V_{T^*}, F_{T^*})$ and a corresponding two-dimensional embedding of vertex coordinates, $U^* \in \mathbb{R}^{2 |V_{T^*}|}$, that locally minimize the constrained parametrization problem
%
\begin{align}
	\min_{T,U} E_s(T) \quad s.t. \quad E_d(T,U) \leq b_d\ \ \text{and}\ \ (T, U) \in \mathcal{I}.
	\label{eq:p1}
\end{align}
%\justin{Might be worth mentioning in a sentence what your representation of $T$ is} \minchen{I haven't thought about defining $T$ explicitly. If needed, it can be a vector of boolean variables representing whether each edge on the 3D surface is a seam edge, subject to manifold mesh constraints.}
%\vova{Binary value over edges requires additional post-process to identify which of two vertices are duplicated and which triangles they should be assigned to. 
%Why not just define a new mesh $(V_T, F_T)$ and a bijective map $f_T: F \rightarrow F_T$?}\danny{My suggestion is that we stick as closely as possible to the rep used in Minchen's code - I've asked him what he uses - we can monge that into text once he replies.} \minchen{Similar to Vova said, I simply use the vertex indices of each face to represent topology as what .obj file does. Should we mention it here or in the implementation section?}
%
Here $V_{T^*}$ forms a superset of $V$ with possibly duplicated vertices, and $F_{T^*}$ is the set of faces indexed into this new set of vertices. We use $\mathcal{I}$ to define the set of \emph{either} locally injective \emph{or} globally bijective UV maps; in the following we will first initially focus on the locally injective set and then later cover our extension to bijectivity. Energies $E_s$ and $E_d$ respectively measure seam quality and map distortion while $b_d$ is a user-specified \emph{upper bound} on the acceptable distortion of the generated map. This optimization is always feasible as in the limit more cuts will always satisfy any distortion bound. %\danny{If we truly want to make bijectivity a first-class component of our method (I'd suggest we do then we should add the bijectivity constraint to the optimization problem statement above and also the derivation that follows - happy to do this once we decide.}

In general, distortion measures are smooth albeit \emph{nonconvex}, while seam measures are \emph{nonsmooth} as they take a discrete jump when mesh edges are cut or merged. Hence, we must address both challenges to design a suitable optimization method. 

%
% e.g. symmetric Dirichlet, MIPS, etc, to measure distortion over the mapped domain. In what follows, for simplicity we largely focus on the symmetric Dirichlet energy and defer examples with other distortion measures for our results to Section\ \ref{}.

%Given an input triangle mesh $M$ of a 3D surface with $n_p$ vertices and its initial UV map with topology $T^0$ and coordinates $U^0 \in \mathbb{R}^{2n_p}$, we automatically search for
%\[ \argmin_{T,U} L(T,U) \]
%where $L(T,U) = E_s(T) + \lambda E_d(T,U)$ is the total energy combining both seam energy $E_s$ and distortion energy $E_d$ with a balancing factor $\lambda \in \mathbb{R^+}$. Notice that usually $E_d$ is smooth, while $E_s$ is defined to be non-differentiable, which gives us a discrete-continuous problem.

\subsection{Dual Objective}
We construct the Lagrangian for (\ref{eq:p1})  % no need to cite the definition of a Lagrangian
\begin{align}
	L(T,U,\lambda) = E_s(T) + \lambda(E_d(T,U) - b_d),
	\label{eq:L}
\end{align}
%
to form the equivalent saddle-point problem~\cite{Bertsekas:2016:NOP} defined over primal variables $T,U$ and dual variable $\lambda$:
%
\begin{align}
	\min_{T,U} \max_{\lambda\geq0} L(T,U,\lambda).
	\label{eq:p2}
\end{align}
%
Here $\lambda \in \mathbb{R_+}$ is the Lagrange multiplier for our distortion bound. On examination the Lagrangian $L$ can be seen as a multi-objective balancing between distortion and seam quality as dictated by $\lambda$. Here, however, $\lambda$ effectively applies a local scaling between the seam and distortion terms that is implied %directly and automatically given 
by the user-specified distortion bound. Within iterations of OptCuts, our algorithm to solve \eqref{eq:p1}, $\lambda$ will thus grow as we threaten to violate our distortion bound and so prioritize distortion minimization; similarly, $\lambda$ will decrease toward $0$ as our bound is strictly satisfied to prioritize seam quality.


\subsection{Mapping Quality Measures}
Concretely we formulate our seam-quality measure as the normalized total seam length
\begin{align}
E_s 
%= E_{SL} 
= \frac{1}{\sqrt{(\sum_{t\in\mathcal{F}} |A_t|)/\pi}} \sum_{i \in \mathcal{S}} |e_i|
\end{align}
where $\mathcal{S}$ is the set of all seam edges on the input surface and $|e_i|$ is the length of edge $i$ in the input mesh.
To measure distortion over the mapped domain we apply the symmetric Dirichlet energy~\cite{Smith2015Bijective} normalized by surface area~\footnote{For simplicity we focus on symmetric Dirichlet here; alternate distortion energies follow similarly.}, 
\begin{align} 
E_d 
%= E_{SD} 
= \frac{1}{\sum_{t\in\mathcal{F}} |A_t|} \sum_{t\in\mathcal{F}} |A_t|(\sigma_{t,1}^2 + \sigma_{t,2}^2 + \sigma_{t,1}^{-2} + \sigma_{t,2}^{-2}),
\end{align}
where $\mathcal{F}$ is the set of all triangles, $|A_t|$ is the area of triangle $t$ on the input surface, and $\sigma_{t,i}$ is the $i$-th singular value of the deformation gradient of triangle $t$.
%We picked this distortion measure among other choices since it efficiently balances between angle and area distortion and preserves local injectivity, but our method can be used with other metrics as well.
%\vova{should we that seam penalties and distortion measure choices are analogues to AutoCuts (but our objective is defined differently?)}
%Also note that our seam penalty and distortion measures are analogous to those used in AutoCuts~\cite{Poranne2017Autocuts}, although the way we combine these terms is different.  
%
%With the energies normalized, $L$ is invariant to coordinate scale and resolution for meshes with the same shape. %\danny{removed as this claim - for mesh resolution it is not true - certainly helps for scaling though.}


\subsection{Adding Global Bijectivity}
Most texture applications additionally require a guarantee of global bijectivity. Following Jiang et al.'s\ \shortcite{Jiang2017Simplicial} observation we realize this additional constraint on our mapping by triangulating the void regions of each iterations updated UV map and then augmenting our distortion energy $E_d$ with an additional term, \emph{not included in the distortion bound constraint}, to form a collapse preventing energy for the added negative-space triangles during each optimization iteration. For details see Section\ \ref{sec:bijectivity}. 
%As these constraints are implicitly encoded in our constraint. The additional objective terms are not added as a term to the distortion bound. Moreover, our framework stays the same when solving this extended problem.

% \danny{Moved and reorganized a good portion of what was here to the next section.}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\paragraph{Joint Discrete-Continuous Search}
%
%Instead of trying to solve an ill-conditioned real-valued optimization by approximating $T$ with $U$ \cite{Poranne2017Autocuts}, we alternatingly optimize $T$ (in topology steps) and $U$ (in descent steps), augmenting the continuous search with a discrete topology search (Section~\ref{sec:DCSearch}).
%
%Descent steps deal with the continuous search
%$\min_U E_d$
%where $T$ is fixed and Newton-type method is applied (Section~\ref{sec:descentStep}).
%Topology steps deal with the discrete search (Section~\ref{sec:topologyStep}) where a neighboring topology is searched based on the first-order reduction it would cause in $L$.
%While each descent step is one complete Newton-type iteration with back-tracking line search, we use a sequence of topology steps alternated with descent steps to perform a forward line search in topology space: a search direction is first decided and then the step size is increased to ensure sufficent energy decrease.
%
%Given a topology change, we evaluate the first-order reduction of $L$ it would cause by minimizing $E_d$ only on the local stencil of the edited seam edge and combine it with the $E_s$ change. Experiments demonstrate that this is efficient and sufficient for always editing the seams reasonably and sustainably (Section~\ref{sec:results_exp}).
%
%Since we ensure $L$ to be monotonically decreased in both the descent steps and topology steps, we can easily prove that a near-stationary point can be reached for any input within a bounded number of alternations (Section~\ref{sec:convergence}).

%\paragraph{Self-Weighted Objective}
%
%To automatically decide $\lambda$ and enable users to directly control the distortion they expect for the output UV map, we formulate a constrained optimization seeking to minimize seam energy $E_s$ subject to user-specified distortion bounds $b_d$:
%\[ \min_{T,U} E_s(T) \quad s.t. \quad E_d(T,U) - b_d \leq 0 \]
%Introducing $\lambda$ as a dual variable gives us
%\[ \min_{T,U} \max_{\lambda \in \mathbb{R^+}} E_s(T) + \lambda(E_d(T,U) - b_d) \]
%We solve it by adding a regularization term to make it smooth for $\lambda$, and alternatingly updating dual variable $\lambda$ and primal variables $T$ and $U$ (Section~\ref{sec:self_weighting}).
%
%The challenge here is that the initial embedding we start from is usually with high distortion, thus infeasible, and the quality of the output seams is highly affected by the $\lambda$ updating scheme. \minchen{[TODO] briefly describe what we do after finalized}
 
 %\danny{I haven't commented it the next paragraph but would suggest we: 1. remove this next paragraph from paper, 2. make bijection a main part of the algorithm and 3. move everything else to future work (if we don't do it) or results (if we do get to it).}\justin{cool w me} 

% \vova{
% I think the structure is a bit confusing (e.g., problem is not entirely defined in ``problem statement'', since we lack precise energy formulation, self-weighted objective talks about outer-look  (alg 1) and then about self-weighting. 
% %
% I propose the following structure: \\
% Section 3: first three paragraphs followed by ``dual objective'' (i.e., exclude "concretely we formulate ...)\\
%  - then write ``energy definition'' paragraph (from sec 5.3 and ``concretely we formulate'' paragraph) \\
 % - then write ``energy with global bijectivity'' paragraph (start ``for most texture applications one needs to ensure global bijecivity, we incorporate this into our energy following Jiang2017...'') \\
 % - [this and below is optional] then write ``optimization framework'' paragraph with Algortihm 1 and first paragraph from section 4. Here reference section 4 for dual update and section 5 for primal update. \\
 % - Note due to the last paragraph, we might change this section from ``Problem Statement'' to ``Optimization Framework''. Alternatively, we can have a separate section (between current 3 and 4, titled ``optimization framework'')\\
 % - Initialization (obtaining $T^0, U^0$ is not described anywhere. We should at least mention it in ``optimization framework'' part of the text. \\
% Section 4: rename into Dual Update \\
% Section 5: rename into Primal Update
% }

%\vova{I suggest we consistently use paragraphs or subsections across sec 3, 4, 5}